<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.fastolf.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="问题解析24 | MySQL是怎么保证主备一致的？2019-01-07 林晓斌 在前面的文章中，我不止一次地和你提到了binlog，大家知道binlog可以用来归档，也可以用来 做主备同步，但它的内容是什么样的呢？为什么备库执行了binlog就可以跟主库保持一致了呢？今天我就正式地和你介绍一下它。毫不夸张地说，MySQL能够成为现下最流行的开源数据库，binlog功不可没。在最开始，MySQL是以">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql-MySQL是怎么保证主备一致的">
<meta property="og:url" content="https://www.fastolf.com/posts/9b1409.html">
<meta property="og:site_name" content="Qi">
<meta property="og:description" content="问题解析24 | MySQL是怎么保证主备一致的？2019-01-07 林晓斌 在前面的文章中，我不止一次地和你提到了binlog，大家知道binlog可以用来归档，也可以用来 做主备同步，但它的内容是什么样的呢？为什么备库执行了binlog就可以跟主库保持一致了呢？今天我就正式地和你介绍一下它。毫不夸张地说，MySQL能够成为现下最流行的开源数据库，binlog功不可没。在最开始，MySQL是以">
<meta property="og:locale">
<meta property="article:published_time" content="2019-11-28T22:14:07.000Z">
<meta property="article:modified_time" content="2023-01-06T09:44:03.140Z">
<meta property="article:author" content="Meng Qi">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://www.fastolf.com/posts/9b1409.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>
<link rel="stylesheet" type="text/css" href="/css/injector/main.css" /><link rel="preload" as="style" href="/css/injector/light.css" /><link rel="preload" as="style" href="/css/injector/dark.css" />
  <title>mysql-MySQL是怎么保证主备一致的 | Qi</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
<a target="_blank" rel="noopener" href="https://github.com/gitmmq" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Qi</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Cogito ergo sum</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://www.fastolf.com/posts/9b1409.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Meng Qi">
      <meta itemprop="description" content="recording">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Qi">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mysql-MySQL是怎么保证主备一致的
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-29 06:14:07" itemprop="dateCreated datePublished" datetime="2019-11-29T06:14:07+08:00">2019-11-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-01-06 17:44:03" itemprop="dateModified" datetime="2023-01-06T17:44:03+08:00">2023-01-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>31 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="问题解析"><a href="#问题解析" class="headerlink" title="问题解析"></a>问题解析</h1><p>24 | MySQL是怎么保证主备一致的？2019-01-07 林晓斌</p>
<p>在前面的文章中，我不止一次地和你提到了binlog，大家知道binlog可以用来归档，也可以用来</p>
<p>做主备同步，但它的内容是什么样的呢？为什么备库执行了binlog就可以跟主库保持一致了呢？今天我就正式地和你介绍一下它。毫不夸张地说，MySQL能够成为现下最流行的开源数据库，binlog功不可没。在最开始，MySQL是以容易学习和方便的高可用架构，被开发人员青睐的。而它的几乎所有的</p>
<p>高可用架构，都直接依赖于binlog。虽然这些高可用架构已经呈现出越来越复杂的趋势，但都是</p>
<p>从最基本的一主一备演化过来的。今天这篇文章我主要为你介绍主备的基本原理。理解了背后的设计原理，你也可以从业务开发的</p>
<p>角度，来借鉴这些设计思想。MySQL主备的基本原理</p>
<p>如图1所示就是基本的主备切换流程。图 1 MySQL主备切换流程</p>
<p>在状态1中，客户端的读写都直接访问节点A，而节点B是A的备库，只是将A的更新都同步过</p>
<p>来，到本地执行。这样可以保持节点B和A的数据是相同的。当需要切换的时候，就切成状态2。这时候客户端读写访问的都是节点B，而节点A是B的备库。在状态1中，虽然节点B没有被直接访问，但是我依然建议你把节点B（也就是备库）设置成只读</p>
<p>（readonly）模式。这样做，有以下几个考虑：</p>
<ol>
<li><p>有时候一些运营类的查询语句会被放到备库上去查，设置为只读可以防止误操作；</p>
</li>
<li><p>防止切换逻辑有bug，比如切换过程中出现双写，造成主备不一致；</p>
</li>
<li><p>可以用readonly状态，来判断节点的角色。你可能会问，我把备库设置成只读了，还怎么跟主库保持同步更新呢？这个问题，你不用担心。因为readonly设置对超级(super)权限用户是无效的，而用于同步更新的</p>
</li>
</ol>
<p>线程，就拥有超级权限。接下来，我们再看看节点A到B这条线的内部流程是什么样的。图2中画出的就是一个update</p>
<p>语句在节点A执行，然后同步到节点B的完整流程图。图2 主备流程图</p>
<p>图2中，包含了我在上一篇文章中讲到的binlog和redo log的写入机制相关的内容，可以看到：主</p>
<p>库接收到客户端的更新请求后，执行内部事务的更新逻辑，同时写binlog。备库B跟主库A之间维持了一个长连接。主库A内部有一个线程，专门用于服务备库B的这个长连</p>
<p>接。一个事务日志同步的完整过程是这样的：</p>
<ol>
<li>在备库B上通过change master命令，设置主库A的IP、端口、用户名、密码，以及要从哪个</li>
</ol>
<p>位置开始请求binlog，这个位置包含文件名和日志偏移量。2. 在备库B上执行start slave命令，这时候备库会启动两个线程，就是图中的io_thread和</p>
<p>sql_thread。其中io_thread负责与主库建立连接。3. 主库A校验完用户名、密码后，开始按照备库B传过来的位置，从本地读取binlog，发给B。4. 备库B拿到binlog后，写到本地文件，称为中转日志（relay log）。5. sql_thread读取中转日志，解析出日志里的命令，并执行。这里需要说明，后来由于多线程复制方案的引入，sql_thread演化成为了多个线程，跟我们今天</p>
<p>要介绍的原理没有直接关系，暂且不展开。分析完了这个长连接的逻辑，我们再来看一个问题：binlog里面到底是什么内容，为什么备库拿</p>
<p>过去可以直接执行。binlog的三种格式对比</p>
<p>我在第15篇答疑文章中，和你提到过binlog有两种格式，一种是statement，一种是row。可能你</p>
<p>在其他资料上还会看到有第三种格式，叫作mixed，其实它就是前两种格式的混合。为了便于描述binlog的这三种格式间的区别，我创建了一个表，并初始化几行数据。如果要在表中删除一行数据的话，我们来看看这个delete语句的binlog是怎么记录的。注意，下面这个语句包含注释，如果你用MySQL客户端来做这个实验的话，要记得加-c参数，否</p>
<p>则客户端会自动去掉注释。当binlog_format&#x3D;statement时，binlog里面记录的就是SQL语句的原文。你可以用</p>
<p>mysql&gt; CREATE TABLE t̀  ̀(</p>
<p>  ìd  ̀int(11) NOT NULL,</p>
<p>  &#96;a  ̀int(11) DEFAULT NULL,</p>
<p>  t̀_modified  ̀timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,</p>
<p>  PRIMARY KEY (̀ id )̀,</p>
<p>  KEY &#96;a  ̀(̀ a )̀,</p>
<p>  KEY t̀_modified (̀̀ t_modified )̀</p>
<p>) ENGINE&#x3D;InnoDB;</p>
<p>insert into t values(1,1,’2018-11-13’);</p>
<p>insert into t values(2,2,’2018-11-12’);</p>
<p>insert into t values(3,3,’2018-11-11’);</p>
<p>insert into t values(4,4,’2018-11-10’);</p>
<p>insert into t values(5,5,’2018-11-09’);</p>
<p>mysql&gt; delete from t &#x2F;<em>comment</em>&#x2F;  where a&gt;&#x3D;4 and t_modified&lt;&#x3D;’2018-11-10’ limit 1;</p>
<p>mysql&gt; show binlog events in ‘master.000001’;</p>
<p>命令看binlog中的内容。图3 statement格式binlog 示例</p>
<p>现在，我们来看一下图3的输出结果。第一行SET @@SESSION.GTID_NEXT&#x3D;’ANONYMOUS’你可以先忽略，后面文章我们会在</p>
<p>介绍主备切换的时候再提到；</p>
<p>第二行是一个BEGIN，跟第四行的commit对应，表示中间是一个事务；</p>
<p>第三行就是真实执行的语句了。可以看到，在真实执行的delete命令之前，还有一个“use</p>
<p>‘test’”命令。这条命令不是我们主动执行的，而是MySQL根据当前要操作的表所在的数据库，</p>
<p>自行添加的。这样做可以保证日志传到备库去执行的时候，不论当前的工作线程在哪个库</p>
<p>里，都能够正确地更新到test库的表t。use ‘test’命令之后的delete 语句，就是我们输入的SQL原文了。可以看到，binlog“忠实”地记</p>
<p>录了SQL命令，甚至连注释也一并记录了。最后一行是一个COMMIT。你可以看到里面写着xid&#x3D;61。你还记得这个XID是做什么用的吗？如果记忆模糊了，可以再回顾一下第15篇文章中的相关内容。为了说明statement 和 row格式的区别，我们来看一下这条delete命令的执行效果图：</p>
<p>图4 delete执行warnings</p>
<p>可以看到，运行这条delete命令产生了一个warning，原因是当前binlog设置的是statement格</p>
<p>式，并且语句中有limit，所以这个命令可能是unsafe的。为什么这么说呢？这是因为delete 带limit，很可能会出现主备数据不一致的情况。比如上面这个</p>
<p>例子：</p>
<ol>
<li>如果delete语句使用的是索引a，那么会根据索引a找到第一个满足条件的行，也就是说删除</li>
</ol>
<p>的是a&#x3D;4这一行；</p>
<ol start="2">
<li>但如果使用的是索引t_modified，那么删除的就是 t_modified&#x3D;’2018-11-09’也就是a&#x3D;5这一</li>
</ol>
<p>行。由于statement格式下，记录到binlog里的是语句原文，因此可能会出现这样一种情况：在主库</p>
<p>执行这条SQL语句的时候，用的是索引a；而在备库执行这条SQL语句的时候，却使用了索引</p>
<p>t_modified。因此，MySQL认为这样写是有风险的。那么，如果我把binlog的格式改为binlog_format&#x3D;‘row’， 是不是就没有这个问题了呢？我们先来</p>
<p>看看这时候binog中的内容吧。图5 row格式binlog 示例</p>
<p>可以看到，与statement格式的binlog相比，前后的BEGIN和COMMIT是一样的。但是，row格式</p>
<p>的binlog里没有了SQL语句的原文，而是替换成了两个event：Table_map和Delete_rows。1. Table_map event，用于说明接下来要操作的表是test库的表t;</p>
<ol start="2">
<li>Delete_rows event，用于定义删除的行为。其实，我们通过图5是看不到详细信息的，还需要借助mysqlbinlog工具，用下面这个命令解析和</li>
</ol>
<p>查看binlog中的内容。因为图5中的信息显示，这个事务的binlog是从8900这个位置开始的，所以</p>
<p>可以用start-position参数来指定从这个位置的日志开始解析。mysqlbinlog  -vv data&#x2F;master.000001 –start-position&#x3D;8900;</p>
<p>图6 row格式binlog 示例的详细信息</p>
<p>从这个图中，我们可以看到以下几个信息：</p>
<p>server id 1，表示这个事务是在server_id&#x3D;1的这个库上执行的。每个event都有CRC32的值，这是因为我把参数binlog_checksum设置成了CRC32。Table_map event跟在图5中看到的相同，显示了接下来要打开的表，map到数字226。现在我</p>
<p>们这条SQL语句只操作了一张表，如果要操作多张表呢？每个表都有一个对应的Table_map</p>
<p>event、都会map到一个单独的数字，用于区分对不同表的操作。我们在mysqlbinlog的命令中，使用了-vv参数是为了把内容都解析出来，所以从结果里面可以</p>
<p>看到各个字段的值（比如，@1&#x3D;4、 @2&#x3D;4这些值）。binlog_row_image的默认配置是FULL，因此Delete_event里面，包含了删掉的行的所有字段</p>
<p>的值。如果把binlog_row_image设置为MINIMAL，则只会记录必要的信息，在这个例子里，</p>
<p>就是只会记录id&#x3D;4这个信息。最后的Xid event，用于表示事务被正确地提交了。你可以看到，当binlog_format使用row格式的时候，binlog里面记录了真实删除行的主键id，这样</p>
<p>binlog传到备库去的时候，就肯定会删除id&#x3D;4的行，不会有主备删除不同行的问题。为什么会有mixed格式的binlog？基于上面的信息，我们来讨论一个问题：为什么会有mixed这种binlog格式的存在场景？推论</p>
<p>过程是这样的：</p>
<p>因为有些statement格式的binlog可能会导致主备不一致，所以要使用row格式。但row格式的缺点是，很占空间。比如你用一个delete语句删掉10万行数据，用statement的</p>
<p>话就是一个SQL语句被记录到binlog中，占用几十个字节的空间。但如果用row格式的binlog，</p>
<p>就要把这10万条记录都写到binlog中。这样做，不仅会占用更大的空间，同时写binlog也要耗</p>
<p>费IO资源，影响执行速度。所以，MySQL就取了个折中方案，也就是有了mixed格式的binlog。mixed格式的意思</p>
<p>是，MySQL自己会判断这条SQL语句是否可能引起主备不一致，如果有可能，就用row格式，</p>
<p>否则就用statement格式。也就是说，mixed格式可以利用statment格式的优点，同时又避免了数据不一致的风险。因此，如果你的线上MySQL设置的binlog格式是statement的话，那基本上就可以认为这是一个</p>
<p>不合理的设置。你至少应该把binlog的格式设置为mixed。比如我们这个例子，设置为mixed后，就会记录为row格式；而如果执行的语句去掉limit 1，就会</p>
<p>记录为statement格式。当然我要说的是，现在越来越多的场景要求把MySQL的binlog格式设置成row。这么做的理由有</p>
<p>很多，我来给你举一个可以直接看出来的好处：恢复数据。接下来，我们就分别从delete、insert和update这三种SQL语句的角度，来看看数据恢复的问</p>
<p>题。通过图6你可以看出来，即使我执行的是delete语句，row格式的binlog也会把被删掉的行的整行</p>
<p>信息保存起来。所以，如果你在执行完一条delete语句以后，发现删错数据了，可以直接把</p>
<p>binlog中记录的delete语句转成insert，把被错删的数据插入回去就可以恢复了。如果你是执行错了insert语句呢？那就更直接了。row格式下，insert语句的binlog里会记录所有的</p>
<p>字段信息，这些信息可以用来精确定位刚刚被插入的那一行。这时，你直接把insert语句转成</p>
<p>delete语句，删除掉这被误插入的一行数据就可以了。如果执行的是update语句的话，binlog里面会记录修改前整行的数据和修改后的整行数据。所</p>
<p>以，如果你误执行了update语句的话，只需要把这个event前后的两行信息对调一下，再去数据</p>
<p>库里面执行，就能恢复这个更新操作了。其实，由delete、insert或者update语句导致的数据操作错误，需要恢复到操作之前状态的情</p>
<p>况，也时有发生。MariaDB的Flashback工具就是基于上面介绍的原理来回滚数据的。虽然mixed格式的binlog现在已经用得不多了，但这里我还是要再借用一下mixed格式来说明一个</p>
<p>问题，来看一下这条SQL语句：</p>
<p>如果我们把binlog格式设置为mixed，你觉得MySQL会把它记录为row格式还是statement格式</p>
<p>呢？先不要着急说结果，我们一起来看一下这条语句执行的效果。图7 mixed格式和now()</p>
<p>可以看到，MySQL用的居然是statement格式。你一定会奇怪，如果这个binlog过了1分钟才传给</p>
<p>备库的话，那主备的数据不就不一致了吗？接下来，我们再用mysqlbinlog工具来看看：</p>
<p>mysql&gt; insert into t values(10,10, now());</p>
<p>图8 TIMESTAMP 命令</p>
<p>从图中的结果可以看到，原来binlog在记录event的时候，多记了一条命令：SET</p>
<p>TIMESTAMP&#x3D;1546103491。它用 SET TIMESTAMP命令约定了接下来的now()函数的返回时</p>
<p>间。因此，不论这个binlog是1分钟之后被备库执行，还是3天后用来恢复这个库的备份，这个insert</p>
<p>语句插入的行，值都是固定的。也就是说，通过这条SET TIMESTAMP命令，MySQL就确保了</p>
<p>主备数据的一致性。我之前看过有人在重放binlog数据的时候，是这么做的：用mysqlbinlog解析出日志，然后把里面</p>
<p>的statement语句直接拷贝出来执行。你现在知道了，这个方法是有风险的。因为有些语句的执行结果是依赖于上下文命令的，直接执</p>
<p>行的结果很可能是错误的。所以，用binlog来恢复数据的标准做法是，用 mysqlbinlog工具解析出来，然后把解析结果整个发</p>
<p>给MySQL执行。类似下面的命令：</p>
<p>这个命令的意思是，将 master.000001 文件里面从第2738字节到第2973字节中间这段内容解析</p>
<p>出来，放到MySQL去执行。循环复制问题</p>
<p>通过上面对MySQL中binlog基本内容的理解，你现在可以知道，binlog的特性确保了在备库执行</p>
<p>相同的binlog，可以得到与主库相同的状态。因此，我们可以认为正常情况下主备的数据是一致的。也就是说，图1中A、B两个节点的内容是</p>
<p>一致的。其实，图1中我画的是M-S结构，但实际生产上使用比较多的是双M结构，也就是图9所</p>
<p>示的主备切换流程。mysqlbinlog master.000001  –start-position&#x3D;2738 –stop-position&#x3D;2973 | mysql -h127.0.0.1 -P13000 -u$user -p$pwd;</p>
<p>图 9 MySQL主备切换流程–双M结构</p>
<p>对比图9和图1，你可以发现，双M结构和M-S结构，其实区别只是多了一条线，即：节点A和B</p>
<p>之间总是互为主备关系。这样在切换的时候就不用再修改主备关系。但是，双M结构还有一个问题需要解决。业务逻辑在节点A上更新了一条语句，然后再把生成的binlog 发给节点B，节点B执行完这条更新</p>
<p>语句后也会生成binlog。（我建议你把参数log_slave_updates设置为on，表示备库执行relay log</p>
<p>后生成binlog）。那么，如果节点A同时是节点B的备库，相当于又把节点B新生成的binlog拿过来执行了一次，然</p>
<p>后节点A和B间，会不断地循环执行这个更新语句，也就是循环复制了。这个要怎么解决呢？从上面的图6中可以看到，MySQL在binlog中记录了这个命令第一次执行时所在实例的server</p>
<p>id。因此，我们可以用下面的逻辑，来解决两个节点间的循环复制的问题：</p>
<ol>
<li><p>规定两个库的server id必须不同，如果相同，则它们之间不能设定为主备关系；</p>
</li>
<li><p>一个备库接到binlog并在重放的过程中，生成与原binlog的server id相同的新的binlog；</p>
</li>
<li><p>每个库在收到从自己的主库发过来的日志后，先判断server id，如果跟自己的相同，表示这</p>
</li>
</ol>
<p>个日志是自己生成的，就直接丢弃这个日志。按照这个逻辑，如果我们设置了双M结构，日志的执行流就会变成这样：</p>
<ol>
<li><p>从节点A更新的事务，binlog里面记的都是A的server id；</p>
</li>
<li><p>传到节点B执行一次以后，节点B生成的binlog 的server id也是A的server id；</p>
</li>
<li><p>再传回给节点A，A判断到这个server id与自己的相同，就不会再处理这个日志。所以，死循</p>
</li>
</ol>
<p>环在这里就断掉了。小结</p>
<p>今天这篇文章，我给你介绍了MySQL binlog的格式和一些基本机制，是后面我要介绍的读写分</p>
<p>离等系列文章的背景知识，希望你可以认真消化理解。binlog在MySQL的各种高可用方案上扮演了重要角色。今天介绍的可以说是所有MySQL高可用</p>
<p>方案的基础。在这之上演化出了诸如多节点、半同步、MySQL group replication等相对复杂的方</p>
<p>案。我也跟你介绍了MySQL不同格式binlog的优缺点，和设计者的思考。希望你在做系统开发时候，</p>
<p>也能借鉴这些设计思想。最后，我给你留下一个思考题吧。说到循环复制问题的时候，我们说MySQL通过判断server id的方式，断掉死循环。但是，这个机</p>
<p>制其实并不完备，在某些场景下，还是有可能出现死循环。你能构造出一个这样的场景吗？又应该怎么解决呢？你可以把你的设计和分析写在评论区，我会在下一篇文章跟你讨论这个问题。感谢你的收听，也</p>
<p>欢迎你把这篇文章分享给更多的朋友一起阅读。上期问题时间</p>
<p>上期我留给你的问题是，你在什么时候会把线上生产库设置成“非双1”。我目前知道的场景，有</p>
<p>以下这些：</p>
<ol>
<li>业务高峰期。一般如果有预知的高峰期，DBA会有预案，把主库设置成“非双1”。2. 备库延迟，为了让备库尽快赶上主库。@永恒记忆和@Second Sight提到了这个场景。3. 用备份恢复主库的副本，应用binlog的过程，这个跟上一种场景类似。4. 批量导入数据的时候。一般情况下，把生产库改成“非双1”配置，是设置innodb_flush_logs_at_trx_commit&#x3D;2、</li>
</ol>
<p>sync_binlog&#x3D;1000。评论区留言点赞板：</p>
<p>Sinyo   2</p>
<p>@way 同学提到了一个有趣的现象，由于从库设置了 binlog_group_commit_sync_delay和</p>
<p>binlog_group_commit_sync_no_delay_count导致一直延迟的情况。我们在主库设置这两个参</p>
<p>数，是为了减少binlog的写盘压力。备库这么设置，尤其在“快要追上”的时候，就反而会受这</p>
<p>两个参数的拖累。一般追主备就用“非双1”（追上记得改回来）。@一大只 同学验证了在sync_binlog&#x3D;0的情况下，设置sync_delay和sync_no_delay_count的</p>
<p>现象，点赞这种发现边界的意识和手动验证的好习惯。是这样的：sync_delay和</p>
<p>sync_no_delay_count的逻辑先走，因此该等还是会等。等到满足了这两个条件之一，就进入</p>
<p>sync_binlog阶段。这时候如果判断sync_binlog&#x3D;0，就直接跳过，还是不调fsync。@锅子 同学提到，设置sync_binlog&#x3D;0的时候，还是可以看到binlog文件马上做了修改。这个</p>
<p>是对的，我们说“写到了page cache”，就是文件系统的page cache。而你用ls命令看到的就是</p>
<p>文件系统返回的结果。精选留言</p>
<p>主库 A 从本地读取 binlog，发给从库 B；</p>
<p>老师，请问这里的本地是指文件系统的 page cache还是disk呢？2019-01-21</p>
<p> 作者回复</p>
<p>好问题，</p>
<p>是这样的，对于A的线程来说，就是“读文件”，</p>
<ol>
<li><p>如果这个文件现在还在 page cache中，那就最好了，直接读走；</p>
</li>
<li><p>如果不在page cache里，就只好去磁盘读</p>
</li>
</ol>
<p>这个行为是文件系统控制的，MySQL只是执行“读文件”这个操作</p>
<p>2019-01-21</p>
<p>Leon    1</p>
<p>老师，我想问下双M架构下，主从复制，是不是一方判断自己的数据比对方少就从对方复制，</p>
<p>判断依据是什么</p>
<p>2019-01-25</p>
<p> 作者回复</p>
<p>好问题。一开始创建主备关系的时候， 是由备库指定的。比如基于位点的主备关系，备库说“我要从binlog文件A的位置P”开始同步， 主库就从这个指定</p>
<p>的位置开始往后发。而主备复制关系搭建完成以后，是主库来决定“要发数据给备库”的。所以主库有生成新的日志，就会发给备库。2019-01-25</p>
<p>观弈道人   6</p>
<p>老师你好，问个备份问题，假如周日23点做了备份，周二20点需要恢复数据，那么在用binlog</p>
<p>恢复时，如何恰好定位到周日23点的binlog,谢谢。2019-01-07</p>
<p> 作者回复</p>
<p>Mysqlbinlog有个参数—stop-datetime</p>
<p>2019-01-07</p>
<p>堕落天使   3</p>
<p>老师，您好，问一个关于change buffer的问题。对于insert语句来说，change buffer的优化主要在非唯一的二级索引上，因为主键是唯一索引，</p>
<p>插入必须要判断是否存在。那么对于update语句呢？如下（假设c有非唯一索引，id是主键，d没有索引）：</p>
<p>update t set d&#x3D;2 where c&#x3D;10;</p>
<p>原先以为：从索引c取出id之后，不会回表，也不会把修改行的数据读入内存，而是直接在chan</p>
<p>ge buffer中记录一下。但看了今天得内容之后又迷糊了，因为如果不把修改行的数据读入内存</p>
<p>，它又怎么把旧数据写入binlog中呢？所以我想问的就是，上面的sql语句会不会把修改行的内容也读进内存？如果读进内存，那读进</p>
<p>内存的这一步难道就为了写binlog吗？如果不读进内存，那binlog中的旧数据又是怎么来的呢？还有delete语句也同理。2019-01-07</p>
<p> 作者回复</p>
<p>修改的行要读入内存呀</p>
<p>写binlog只需要主键索引上的值</p>
<p>你这个语句的话，如果字段c d上都有索引，那么c用不上chsnge buffer,</p>
<p>D可能可以同上</p>
<p>2019-01-07</p>
<p>hua168   2</p>
<p>大神，我前些天去面试，面试官问了一题:</p>
<p>mysql做主从，一段时间后发现从库在高峰期会发生一两条条数据丢失（不记得是查询行空白</p>
<p>还是查询不到了），主从正常，怎么判断？1.我问他是不是所以从库都是一样，他说不一样</p>
<p>2.我说低峰期重做新的从库观察，查看日志有没有报错？他好像不满意这个答案。二、他还问主库挂了怎么办？1. mysql主从+keepalived&#x2F;heartbeat</p>
<p>有脑裂，还是有前面丢数据问题</p>
<ol start="2">
<li>用MMM或HMA之类</li>
</ol>
<p>3.用ZK之类</p>
<p>三、写的压力大怎么办？我回答，分库，分表</p>
<p>感觉整天他都不怎么满意，果然没让我复试了，我郁闷呀，我就面试运维的，问数据这么详细</p>
<p>。 </p>
<p>大神，能说下我哪里有问题吗？现在我都想不明白 </p>
<p>2019-01-08</p>
<p> 作者回复</p>
<p>运维现在要求也挺高的</p>
<p>第一个问题其实我也没看懂，“高峰期丢数据”是指主备延迟查不到数据，还是真的丢了，得先</p>
<p>问清楚下</p>
<p>不过你回答的第二点不太好，低峰期重做这个大家都知道要这么做，而且只是修复动作，没办</p>
<p>法用来定位原因，面试官是要问你分析问题的方法（方向错误）</p>
<p>重搭从库错误日志里面什么都没有的（这个比较可惜，暴露了对字节不够了解，一般不了解的</p>
<p>方法在面试的时候是不如不说的）</p>
<p>第二个问题三点都是你回答的吗？那还算回答得可以的，但是不能只讲名词，要找个你熟悉细</p>
<p>节的方案展开一下</p>
<p>三方向也是对的</p>
<p>我估计就是第一个问题减分比较厉害</p>
<p>2019-01-08</p>
<p>HuaMax   2</p>
<p>课后题。如果在同步的过程中修改了server id，那用原server id 生成的log被两个M认为都不是</p>
<p>自己的而被循环执行，不知这种情况会不会发生</p>
<p>2019-01-07</p>
<p> 作者回复</p>
<p>是的，会</p>
<p>2019-01-07</p>
<p>风二中   1</p>
<p>在主库执行这条 SQL 语句的时候，用的是索引 a；而在备库执行这条 SQL 语句的时候，却使</p>
<p>用了索引 t_modified</p>
<p>老师，您好，这里索引选择不一样，是因为前面提到的mysql 会选错索引吗？这种情况应该发</p>
<p>生比较少吧，这里应该都会选择索引a吧，还是说这里只是一个事例，还有更复杂的情况</p>
<p>2019-01-12</p>
<p> 作者回复</p>
<p>对，只是一个举例的</p>
<p>2019-01-12</p>
<p>夜空中最亮的星（华仔）   1</p>
<p>级联复制，3个数据库，首尾相连，应会出现死循环</p>
<p>2019-01-08</p>
<p> 作者回复</p>
<p>不会哦，1给2，2给3，3给1，1就放弃了</p>
<p>不过引入第三个节点的思路是对的哈 </p>
<p>2019-01-08</p>
<p>changshan   1</p>
<p>老师好，mixed是row和statement的优点整合折中方案，这应该是好多系统设计理念吧？那么</p>
<p>问题一：mixed既然能判断是什么时候使用row，什么时候使用statement，那么为什么好多推</p>
<p>荐都是使用row而且不是使用mixed呢？是因为mixed这种模式下的自动选择转换不准确可能会</p>
<p>出现主从问题吗？问题二：当使用mixed模式情况下，mysql内部是怎么判断的呢？比如有limit</p>
<p>语句就会选择记录row格式，有now()函数还是同样会记录statement格式，mysql只是简单的某</p>
<p>些特定场景下会使用记录row格式吗？谢谢。2019-01-07</p>
<p> 作者回复</p>
<ol>
<li><p>就是我们文中后面说的那些原因，要用这些binlog的内容去做别的事情 </p>
</li>
<li><p>对，固定模式下的。好问题，我去拉不下最新版本代码看下规则</p>
</li>
</ol>
<p>2019-01-07</p>
<p>柚子   1</p>
<p>大佬您好，文中说现在越来越多的使用row方式的binlog，那么只能选择接受写入慢和占用空间</p>
<p>大的弊端么？2019-01-07</p>
<p> 作者回复</p>
<p>是的，当然还有minimal可选，会好些 </p>
<p>2019-01-07</p>
<p>汪炜   0</p>
<p>老师，问个问题，希望能被回答：</p>
<p>mmysql不是双一设置的时候，破坏了二阶段提交，事务已提交，redo没有及时刷盘，binlog刷</p>
<p>盘了，这种情况，mysql是怎么恢复的，这个事务到底算不算提交？2019-01-23</p>
<p> 作者回复</p>
<p>如果”redo没有及时刷盘，binlog刷盘了”之后瞬间数据库所在主机掉电，</p>
<p>主机重启，MySQL重启以后，这个事务会丢失；这里确实会引起日志和数据不一致，</p>
<p>这个就是我们说要默认设置为双1的原因之一哈</p>
<p>2019-01-23</p>
<p>Mackie .Weng   0</p>
<p>老师，你的课真好， 你讲的都是生产实际用到的，点赞~</p>
<p>不过近期有点苦恼，要请教一下近期遇到的事</p>
<p>场景：</p>
<p>SSD硬盘，我们数据一天一备份，想通过昨天凌晨备份+binlog恢复到最新数据，导出的binlog</p>
<p>为2G，然后发现导入binlog花费了4，5小时，看了下binlog日志里面有很多这种信息</p>
<h1 id="at-2492"><a href="#at-2492" class="headerlink" title="at 2492"></a>at 2492</h1><p>#190108 17:08:38 server id 2 end_log_pos 2601 CRC32 0x8b0598ec Query thread_id&#x3D;1227779</p>
<p>5 exec_time&#x3D;0 error_code&#x3D;0</p>
<p>SET TIMESTAMP&#x3D;1546938518&#x2F;<em>!</em>&#x2F;;</p>
<p>BEGIN</p>
<p>&#x2F;<em>!</em>&#x2F;;</p>
<h1 id="at-2601"><a href="#at-2601" class="headerlink" title="at 2601"></a>at 2601</h1><h1 id="at-2633"><a href="#at-2633" class="headerlink" title="at 2633"></a>at 2633</h1><h1 id="at-2919"><a href="#at-2919" class="headerlink" title="at 2919"></a>at 2919</h1><p>#190108 17:08:38 server id 2 end_log_pos 2950 CRC32 0x13806369 Xid &#x3D; 1924155105</p>
<p>COMMIT&#x2F;<em>!</em>&#x2F;;</p>
<p>问题：</p>
<p>1、在导出binlog为2G而且看了下里面很多这种事务，这是什么东西，有什么用吗</p>
<p>2、这种事务在导出binlog的时候可以不记录吗，然后来提高恢复数据的速度？3、如果这是正常的情况，有无推荐更好的数据恢复方案或者工具</p>
<p>感谢老师</p>
<p>2019-01-14</p>
<p> 作者回复</p>
<ol>
<li><p>有用，最好保留这些信息一起执行；</p>
</li>
<li><p>提升不了多少速度的，花时间主要还是在更新数据的那些日志上，那些日志又不能去掉的：</p>
</li>
</ol>
<p>）</p>
<ol start="3">
<li>这个方案是串行恢复。你可以把全量恢复出来的库，接成线上一个从库的备库，开并行复制</li>
</ol>
<p>，</p>
<p>2019-01-14</p>
<p>秋一匹   0</p>
<p>老师，您好。我这慢了一步。。。学习晚了点。我这之前碰到了个问题，有一段时间主从复制</p>
<p>延迟比较厉害，达到5s左右吧，一般都是1～2秒吧。首先排除不是网络原因。想问下还有哪些</p>
<p>因素会影响主从复制呢？2019-01-10</p>
<p> 作者回复</p>
<p>还是要给一下更具体的信息</p>
<p>比如主库的tps</p>
<p>备库的跟复制相关的配置等信息</p>
<p>2019-01-10</p>
<p>Mr.Strive.Z.H.L   0</p>
<p>老师你好：</p>
<p>有一个疑惑，多条语句同时在commit阶段过程中，如果发生写入binlog和写入redolog的顺序不</p>
<p>一致的情况。主从备份的时候，从库是不是会导致数据不一致呀？2019-01-10</p>
<p>未知   0</p>
<p>老师在讲row模式的数据恢复时，感觉insert，update，delete的数据格式和undo log的差不多。之前文章一直说redo和binlog，老师抽空也讲下undo和回滚段的知识。2019-01-10</p>
<p> 作者回复</p>
<p>Undo前面大致有说过了，你要了解undo的什么内容呢</p>
<p>2019-01-10</p>
<p>光   0</p>
<p>林老师今天遇到个问题就是主从同步延迟，查到主从状态中出现：Slave_SQL_Running_State: </p>
<p>Waiting for Slave Workers to free pending events。不知道这个是否会引起延迟。查了些资料说</p>
<p>得都不是很明白。老师是否可以简短解答下。以及这种延迟如何避免。2019-01-09</p>
<p> 作者回复</p>
<p>这个的意思是， 现在工作线程里面等待的队列太多，都已经超过上限了，要等工作线程消化掉</p>
<p>一些事务再分</p>
<p>简单说，就是备库的应用日志的队列太慢了。。2019-01-10</p>
<p>梁中华   0</p>
<p>我有一个比较极端一点的HA问题，假设主库的binlog刚写成功还未来得及把binlog同步到从库，</p>
<p>主库就掉电了，这时候从库的数据会不完整吗？第二个问题，原主库重启加入集群后，那条没有传出去的binlog会如何处理？2019-01-09</p>
<p>不迷失   0</p>
<p>请教一下，生产环境能不能使用正常使用表连接？要注意哪些地方？DBA总是说不建议用，还</p>
<p>催促我将使用了表连接的地方改造，但也说不出个所以然。目前在两个百万级数据的表中有用</p>
<p>到内连接，并没有觉得有什么问题</p>
<p>2019-01-08</p>
<p> 作者回复</p>
<p>索引使用正确，不要出现全表扫描，其实OK的</p>
<p>2019-01-08</p>
<p>hua168   0</p>
<p>这样，我是想增加一些经验，怕后面试又遇到，想问一下大神分析思路，这种问题没经验回答</p>
<p>。我就差点回答用阿里云的DRDS了 </p>
<p>现在开源的mysql中间件生存环境中用什么比较多呀？mycat还是网易的cetus？海量存储阿里云有OSS，有没有对应的开源软件呀？用于生存环境的，没有接触过，想问下，</p>
<p>搞下实验后再去找工作。 </p>
<p>2019-01-08</p>
<p> 作者回复</p>
<p>中间件作为练手这些都可以的</p>
<p>你搜“开源分布式存储系统”</p>
<p>2019-01-08</p>
<p>React   0</p>
<p>老师好，文章前面说主从最好从机设置readonly.那么在双主的情况(互为主备)下，设置不同的</p>
<p>自增值是否就可以不用设置只读了？且此时复制是否可以跳过主键冲突，因为自增值不同？2019-01-08</p>
<p> 作者回复</p>
<p>如果自增值严格控制了，也没必要设置跳过主键冲突了对吧（反正不冲突）</p>
<p>除非你的业务就是设计好支持多点写入，否则还是把不写入的都设置上readonly吧</p>
<p>2019-01-08</p>
<pre><code>
</code></pre>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"># mysql</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/4c5bdfaf.html" rel="prev" title="mysql-MySQL是怎么保证数据不丢的">
      <i class="fa fa-chevron-left"></i> mysql-MySQL是怎么保证数据不丢的
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/9d443267.html" rel="next" title="mysql-MySQL是怎么保证高可用的">
      mysql-MySQL是怎么保证高可用的 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%A7%A3%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">问题解析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#at-2492"><span class="nav-number">2.</span> <span class="nav-text">at 2492</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#at-2601"><span class="nav-number">3.</span> <span class="nav-text">at 2601</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#at-2633"><span class="nav-number">4.</span> <span class="nav-text">at 2633</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#at-2919"><span class="nav-number">5.</span> <span class="nav-text">at 2919</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Meng Qi</p>
  <div class="site-description" itemprop="description">recording</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">342</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Meng Qi</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">390k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">23:40</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>
-->

<div>
<span id="timeDate">loading...</span><span id="times">loading...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("1/1/2018 00:00:00");
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
setInterval("createtime()",250);
</script>
</div>
        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
<div class="moon-menu">
  <div class="moon-menu-items">
    
    <div id="moon-menu-item-back2bottom" class="moon-menu-item">
      <i class='fas fa-chevron-down'></i>    </div>
    
    <div id="moon-menu-item-back2top" class="moon-menu-item">
      <i class='fas fa-chevron-up'></i>    </div>
    
  </div>
  <div class="moon-menu-button">
    <svg class="moon-menu-bg">
      <circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle>
      <circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle>
    </svg>
    <div class="moon-menu-content">
      <div class="moon-menu-icon"><i class='fas fa-ellipsis-v'></i></div>
      <div class="moon-menu-text"></div>
    </div>
  </div>
</div><script src="/js/injector.js"></script>
</body>
</html>
